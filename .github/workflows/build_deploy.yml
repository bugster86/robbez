name: CI/CD WebAssembly (Emscripten & GitHub Pages)

on:
  push:
    branches:
      - main

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read     # Necessario per checkout e upload dell'artifact
      pages: write       # Necessario per l'Action deploy-pages
      id-token: write    # NECESSARIO PER RISOLVERE L'ERRORE (OIDC)
    steps:
      - name: 1. Checkout Working Copy
        # Questo deve essere il primo step per clonare il repository
        uses: actions/checkout@v5

      # --- Setup Emscripten (Necessario per trovare emcc) ---
      - name: 2. Installiamo cmake e dependencies
        run: sudo apt install -y cmake

      - name: 3. Clona e installa emsdk
        # Clona emsdk in una cartella temporanea
        run: git clone https://github.com/emscripten-core/emsdk.git

      - name: Install emsdk
        run: ./emsdk install latest
        working-directory: emsdk
      - name: Activate emsdk
        run: ./emsdk activate latest
        working-directory: emsdk

      - name: Aggiungere emsdk e emscripten alla variabile PATH
        run: |
          source "/home/runner/work/robbez/robbez/emsdk/emsdk_env.sh"
          echo "PATH=$PATH" >> $GITHUB_ENV

      # --- Compilazione Wasm ---
      - name: 5. Compilazione del Progetto WebAssembly
        # Questa directory (build) Ã¨ dove dovrai mettere i file .html, .js, .wasm
        run: |
          mkdir distro
          make build
          # Assicurati che i file .html/.js/.wasm siano in ./build
          cp -r -t distro *.html *.wasm *.js resources

      # --- Deployment su GitHub Pages ---
      - name: 6. Configurazione per il Deploy
        # L'Action ha bisogno del nome del repository per costruire l'URL corretto (es. /robbez)
        uses: actions/configure-pages@v4

      - name: 7. Deploy su GitHub Pages
        # Questa action prende il contenuto della directory 'build' e lo pubblica
        # sul branch 'gh-pages' o direttamente sul branch di deploy di Pages.
        uses: actions/upload-pages-artifact@v3
        with:
          # Carica i file di output (il file .html, .js e .wasm)
          path: 'distro' 
      
      - name: 8. Pubblicazione
        id: deployment
        uses: actions/deploy-pages@v4
